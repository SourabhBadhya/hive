SELECT 'Upgrading MetaStore schema from 4.0.0-alpha-2 to 4.0.0' AS Status from dual;

-- HIVE-26221
ALTER TABLE TAB_COL_STATS ADD HISTOGRAM BLOB;
ALTER TABLE PART_COL_STATS ADD HISTOGRAM BLOB;

-- HIVE-26719
ALTER TABLE COMPACTION_QUEUE ADD CQ_NUMBER_OF_BUCKETS INTEGER;
ALTER TABLE COMPLETED_COMPACTIONS ADD CC_NUMBER_OF_BUCKETS INTEGER;

-- HIVE-26735
ALTER TABLE COMPACTION_QUEUE ADD CQ_ORDER_BY VARCHAR(4000);
ALTER TABLE COMPLETED_COMPACTIONS ADD CC_ORDER_BY VARCHAR(4000);

-- HIVE-26704
CREATE TABLE MIN_HISTORY_WRITE_ID (
  MH_TXNID NUMBER(19) NOT NULL REFERENCES TXNS (TXN_ID),
  MH_DATABASE VARCHAR2(128) NOT NULL,
  MH_TABLE VARCHAR2(256) NOT NULL,
  MH_WRITEID NUMBER(19) NOT NULL
);

-- HIVE-27165
DROP INDEX TAB_COL_STATS_IDX;
CREATE INDEX TAB_COL_STATS_IDX ON TAB_COL_STATS (DB_NAME, TABLE_NAME, COLUMN_NAME, CAT_NAME);
DROP INDEX PCS_STATS_IDX;
CREATE INDEX PCS_STATS_IDX ON PART_COL_STATS (DB_NAME,TABLE_NAME,COLUMN_NAME,PARTITION_NAME,CAT_NAME);

-- HIVE-27332
CREATE TABLE TXN_CLEANUP_QUEUE (
  TCQ_DATABASE varchar(128) NOT NULL,
  TCQ_TABLE varchar(256) NOT NULL,
  TCQ_PARTITION varchar(767),
  TCQ_RETRY_TIME NUMBER(19),
  TCQ_RETRY_RETENTION NUMBER(19) DEFAULT 0 NOT NULL,
  TCQ_ERROR_MESSAGE CLOB
);

-- These lines need to be last.  Insert any changes above.
UPDATE VERSION SET SCHEMA_VERSION='4.0.0', VERSION_COMMENT='Hive release version 4.0.0' where VER_ID=1;
SELECT 'Finished upgrading MetaStore schema from 4.0.0-alpha-2 to 4.0.0' AS Status from dual;
